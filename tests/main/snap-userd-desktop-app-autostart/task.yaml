summary: Check that snap userd can autostart user session applications

# ubuntu-14.04: too old journalctl
systems: [-ubuntu-14.04-*]

execute: |
    echo "When the snap is installed"
    . $TESTSLIB/snaps.sh
    install_local test-snapd-xdg-autostart

    # run the app directly, it will dump a *.desktop file
    snap run test-snapd-xdg-autostart.foo

    echo "And snap application autostart file exists"
    test -e ~/snap/test-snapd-xdg-autostart/current/.config/autostart/foo.desktop

    echo "Applications can be automatically started by snap userd --autostart"

    test ! -e ~/snap/test-xdg-snap-autostart/current/foo-autostarted
    cursor=$(journalctl --show-cursor -n 0 |grep cursor | cut -f3 -d' ')
    snap userd --autostart > autostart.log 2>&1

    # when app is autostarted it dumps a file at $SNAP_USER_DATA/foo-autostarted,
    # applications are forked by userd, but userd does not wait for them
    for i in `seq 20`; do
        test -e ~/snap/test-snapd-xdg-autostart/current/foo-autostarted && break
        sleep 1
    done
    test -e ~/snap/test-snapd-xdg-autostart/current/foo-autostarted

    journalctl --flush
    test "$(journalctl -t foo.desktop --after-cursor=$cursor | wc -l)" -eq 1

restore: |
    rm -f ~/snap/test-snapd-xdg-autostart/current/foo-autostarted
    rm -f ~/snap/test-snapd-xdg-autostart/current/.config/autostart/foo.desktop
