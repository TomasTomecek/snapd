summary: Build the test suite for C code using clang and run it
prepare: |
    # Sanity check, the core snap is installed
    snap info core | MATCH "installed:"
    # Install build dependencies for the test
    dpkg --get-selections > pkg-list
    make -C "$SPREAD_PATH" distclean || true
    # install clang
    . "$TESTSLIB/pkgdb.sh"
    distro_install_package clang
execute: |
    cd "$SPREAD_PATH/cmd/"
    CC=clang WITH_UNIT_TESTS=1 ./autogen.sh
    # Build and run unit tests
    make check
restore: |
    make -C "$SPREAD_PATH" distclean
    # Remove any installed packages
    dpkg --set-selections < pkg-list
    rm -f pkg-list
debug: |
    # Show the test suite failure log if there's one
    cat "$SPREAD_PATH/cmd/autogarbage/test-suite.log" || true
